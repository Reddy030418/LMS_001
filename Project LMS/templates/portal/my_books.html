{% extends 'portal/base.html' %}

{% block title %}My Books – ANU Library{% endblock %}

{% block content %}
<h3 class="mt-3">My Books</h3>

<!-- Current Loans -->
<h5 class="mt-4">Currently Issued</h5>
{% if active_loans %}
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Title</th>
          <th>Department</th>
          <th>Issued On</th>
          <th>Due Date</th>
          <th>Fine (Today)</th>
        </tr>
      </thead>
      <tbody>
        {% for tx in active_loans %}
          <tr>
            <td>
              <a href="{% url 'book_detail' tx.book.id %}">
                {{ tx.book.title }}
              </a>
            </td>
            <td>{{ tx.book.department.name|default:"-" }}</td>
            <td>{{ tx.issued_on|date:"d M Y" }}</td>
            <td>{{ tx.due_date|date:"d M Y" }}</td>
            <td>
              {% if tx.is_overdue %}
                <span class="text-danger">₹{{ tx.fine_amount }}</span>
              {% else %}
                <span class="text-success">No fine</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <p class="text-muted">You have no active issued books.</p>
{% endif %}

<!-- Past History -->
<h5 class="mt-4">Past History</h5>
{% if history %}
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Title</th>
          <th>Department</th>
          <th>Issued On</th>
          <th>Returned On</th>
          <th>Fine Paid</th>
        </tr>
      </thead>
      <tbody>
        {% for tx in history %}
          <tr>
            <td>
              <a href="{% url 'book_detail' tx.book.id %}">
                {{ tx.book.title }}
              </a>
            </td>
            <td>{{ tx.book.department.name|default:"-" }}</td>
            <td>{{ tx.issued_on|date:"d M Y" }}</td>
            <td>{{ tx.returned_on|date:"d M Y" }}</td>
            <td>₹{{ tx.fine_amount }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <p class="text-muted">No previous transactions to display.</p>
{% endif %}

<!-- AI Recommendations -->
<h5 class="mt-4">Recommended For You (AI-Based)</h5>
{% if recommendations %}
  <div class="book-strip mb-5">
    <div class="book-scroller">
      {% for book in recommendations %}
        <div class="book-card">
          {% if book.cover_image %}
            <img src="{{ book.cover_image.url }}" class="book-cover-img" alt="{{ book.title }}" />
          {% else %}
            <div class="book-cover-placeholder">
              {{ book.title|truncatechars:40 }}
            </div>
          {% endif %}
          <div class="book-title">{{ book.title }}</div>
          <a href="{% url 'book_detail' book.id %}" class="btn btn-primary btn-sm book-btn">
            View
          </a>
        </div>
      {% endfor %}
    </div>
  </div>
{% else %}
  <p class="text-muted mb-5">No recommendations yet. Borrow some books to get personalised suggestions.</p>
{% endif %}
{% endblock %}
